<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Conciencia Fonológica</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font for better aesthetics -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales del cuerpo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Un color de fondo suave */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        /* Estilos del contenedor principal del juego */
        #game-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 900px;
            width: 100%;
            text-align: center;
            border: 4px solid #4CAF50; /* Borde temático */
            position: relative; /* Para posicionar el score */
        }
        /* Estilos para botones principales */
        .btn {
            background-color: #4CAF50; /* Verde principal */
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        /* Estilos para botones de opción de respuesta */
        .option-btn {
            background-color: #90CAF9; /* Azul claro */
            color: #1A237E; /* Azul oscuro para texto */
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            border: 2px solid #64B5F6;
            flex-grow: 1; /* Para que ocupen espacio igual */
            margin: 8px; /* Espacio entre botones */
            min-width: 120px; /* Ancho mínimo para legibilidad */
        }
        .option-btn:hover {
            background-color: #64B5F6;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }
        /* Estilo para botón de opción seleccionado (para segmentar sílabas) */
        .option-btn.selected {
            background-color: #FFC107; /* Amarillo para seleccionado */
            border-color: #FFA000;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        /* Estilo para botón de opción correcto */
        .option-btn.correct {
            background-color: #81C784; /* Verde para correcto */
            border-color: #4CAF50;
        }
        /* Estilo para botón de opción incorrecto */
        .option-btn.incorrect {
            background-color: #EF9A9A; /* Rojo para incorrecto */
            border-color: #F44336;
        }
        /* Estilos para el mensaje de retroalimentación */
        #feedback-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
            min-height: 50px; /* Para evitar CLS (Cumulative Layout Shift) */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .feedback-correct {
            background-color: #DCEDC8; /* Verde muy claro */
            color: #2E7D32; /* Verde oscuro */
            border: 2px solid #8BC34A;
        }
        .feedback-incorrect {
            background-color: #FFCDD2; /* Rojo muy claro */
            color: #D32F2F; /* Rojo oscuro */
            border: 2px solid #F44336;
        }
        /* Estilos para la visualización de la puntuación */
        #score-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #FFF3E0; /* Naranja claro */
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 700;
            color: #EF6C00;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        /* Estilos para la imagen de la actividad */
        #activity-image {
            max-width: 180px;
            height: auto;
            border-radius: 15px;
            border: 3px solid #FFAB40; /* Borde para imágenes */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        /* Ajustes responsivos para pantallas medianas */
        @media (max-width: 768px) {
            #game-container {
                padding: 20px;
            }
            .btn, .option-btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
            .level-select-grid, .options-grid {
                flex-direction: column; /* Apila botones en pantallas pequeñas */
            }
        }
        /* Ajustes responsivos para pantallas pequeñas (móviles) */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            #game-container {
                border-radius: 10px;
                padding: 15px;
            }
            #score-display {
                top: 10px;
                right: 10px;
                padding: 5px 10px;
                font-size: 0.8em;
            }
            #activity-image {
                max-width: 120px;
            }
            .option-btn {
                margin: 5px;
            }
            #feedback-message {
                font-size: 1em;
                padding: 10px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="game-container" class="bg-white rounded-xl shadow-lg p-8 max-w-2xl w-full relative">
        <!-- Puntuación General del Juego -->
        <div id="score-display">Puntuación: 0</div>

        <!-- Pantalla de Bienvenida al Juego -->
        <div id="welcome-screen" class="text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">¡Aprende Fonología Jugando!</h1>
            <p class="text-lg text-gray-600 mb-8">
                Bienvenido/a a este juego interactivo diseñado para fortalecer tu conciencia fonológica.
                Trabajaremos con sílabas, sonidos dentro de las palabras y los sonidos individuales de las letras.
                ¡Prepárate para divertirte y aprender!
            </p>
            <button id="start-game-btn" class="btn text-xl">
                Comenzar Juego
                <!-- Icono de Lucide: play-circle -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play-circle"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
            </button>
        </div>

        <!-- Pantalla de Selección de Nivel -->
        <div id="level-selection-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Selecciona un Nivel</h2>
            <div class="flex flex-wrap justify-center gap-4 level-select-grid">
                <button data-level="silabica" class="btn text-xl">
                    <!-- Icono de Lucide: square-equal -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-equal"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 10h10"/><path d="M7 14h10"/></svg>
                    Conciencia Silábica
                </button>
                <button data-level="intrasilabica" class="btn text-xl">
                    <!-- Icono de Lucide: ruler -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ruler"><path d="M22 17H2L12 2L22 17Z"/><path d="M12 15L7 10L12 5L17 10L12 15Z"/></svg>
                    Conciencia Intrasilábica
                </button>
                <button data-level="fonemica" class="btn text-xl">
                    <!-- Icono de Lucide: a-large-small -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-a-large-small"><path d="M21 14H11"/><path d="M15 14l1.5-4L18 14"/><path d="M3 16h5c.3 0 .5-.2.5-.5V7.5c0-.8-.7-1.5-1.5-1.5h-2c-.8 0-1.5.7-1.5 1.5v8"/><path d="M12.5 6.5L11 9h8"/></svg>
                    Conciencia Fonémica
                </button>
            </div>
        </div>

        <!-- Pantalla de Juego Activa -->
        <div id="game-screen" class="hidden text-center">
            <h3 id="level-title" class="text-2xl font-semibold text-gray-700 mb-4"></h3>
            <p id="question-text" class="text-xl text-gray-800 mb-4"></p>
            <img id="activity-image" class="mx-auto my-4 rounded-lg shadow-md border-4 border-yellow-500" alt="Imagen de la actividad">

            <!-- Botón para reproducir sonido (simulado para esta demostración) -->
            <button id="play-sound-btn" class="btn text-base mb-4">
                Reproducir Sonido
                <!-- Icono de Lucide: volume-2 -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M22.39 2.61a15 15 0 0 1 0 18.78"/></svg>
            </button>

            <!-- Área donde se cargarán las opciones de respuesta -->
            <div id="options-container" class="flex flex-wrap justify-center gap-3 mt-4 options-grid">
                <!-- Las opciones se inyectarán aquí dinámicamente por JavaScript -->
            </div>

            <!-- Mensaje de retroalimentación para el usuario -->
            <div id="feedback-message" class="hidden mt-6"></div>

            <!-- Botón para avanzar a la siguiente actividad -->
            <button id="next-activity-btn" class="btn mt-6 hidden">
                Siguiente Actividad
                <!-- Icono de Lucide: arrow-right-circle -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="m12 16 4-4-4-4"/></svg>
            </button>
        </div>

        <!-- Pantalla de Resumen de Nivel al completar un nivel -->
        <div id="level-summary-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">¡Nivel Completado!</h2>
            <p class="text-xl text-gray-700 mb-4">Has terminado el nivel de <span id="summary-level-name" class="font-bold text-blue-600"></span>.</p>
            <p class="text-2xl font-semibold text-gray-800 mb-6">Tu puntuación en este nivel: <span id="level-score-display" class="text-green-600">0</span> de <span id="level-total-questions" class="text-gray-600">0</span></p>
            <button id="return-to-levels-btn" class="btn text-lg mr-4">
                Volver a Niveles
                <!-- Icono de Lucide: arrow-left-circle -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left-circle"><circle cx="12" cy="12" r="10"/><path d="M16 12H8"/><path d="m12 8-4 4 4 4"/></svg>
            </button>
            <button id="restart-game-from-summary-btn" class="btn text-lg">
                Reiniciar Juego
                <!-- Icono de Lucide: rotate-ccw -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-ccw"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.76 2.75L3 8"/><path d="M3 3v5h5"/></svg>
            </button>
        </div>

        <!-- Pantalla de Juego Finalizado al completar todos los niveles -->
        <div id="game-over-screen" class="hidden text-center">
            <h2 class="text-4xl font-bold text-green-700 mb-6">¡Juego Completado!</h2>
            <p class="text-2xl text-gray-800 mb-4">¡Felicidades, has terminado todas las actividades!</p>
            <p class="text-3xl font-bold text-blue-700 mb-6">Tu puntuación total: <span id="final-score-display" class="text-purple-600">0</span></p>
            <p class="text-lg text-gray-600 mb-8">
                ¡Sigue practicando para mejorar aún más tu conciencia fonológica!
            </p>
            <button id="restart-game-btn" class="btn text-xl">
                Jugar de Nuevo
                <!-- Icono de Lucide: refresh-ccw -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.76 2.75L3 8"/><path d="M3 3v5h5"/><path d="M21 12a9 9 0 0 0-9 9 9.75 9.75 0 0 0 6.76-2.75L21 16"/><path d="M21 21v-5h-5"/></svg>
            </button>
        </div>
    </div>

    <script>
        // Definición de los datos del juego para cada nivel (silábica, intrasilábica, fonémica)
        const gameData = {
            silabica: [
                {
                    id: 'silabica-1',
                    type: 'segmentar-silabas',
                    prompt: 'manzana',
                    image: 'https://placehold.co/200x200/FFD700/000?text=Manzana', // Placeholder image for Manzana
                    correctAnswer: ['man', 'za', 'na'],
                    options: ['man', 'za', 'na', 'na', 'zan', 'ma']
                },
                {
                    id: 'silabica-2',
                    type: 'contar-silabas',
                    prompt: 'elefante',
                    image: 'https://placehold.co/200x200/ADD8E6/000?text=Elefante', // Placeholder image for Elefante
                    correctAnswer: 4,
                    options: [2, 3, 4, 5]
                },
                {
                    id: 'silabica-3',
                    type: 'segmentar-silabas',
                    prompt: 'mariposa',
                    image: 'https://placehold.co/200x200/FFB6C1/000?text=Mariposa', // Placeholder image for Mariposa
                    correctAnswer: ['ma', 'ri', 'po', 'sa'],
                    options: ['ma', 'po', 'ri', 'sa', 'pa', 'mo']
                },
                {
                    id: 'silabica-4',
                    type: 'contar-silabas',
                    prompt: 'computadora',
                    image: 'https://placehold.co/200x200/B0E0E6/000?text=Computadora', // Placeholder image for Computadora
                    correctAnswer: 5,
                    options: [3, 4, 5, 6]
                }
            ],
            intrasilabica: [
                {
                    id: 'intrasilabica-1',
                    type: 'encontrar-rimas',
                    prompt: 'sol',
                    image: 'https://placehold.co/200x200/FF4500/FFF?text=Sol', // Placeholder image for Sol
                    correctAnswer: 'col',
                    options: [
                        { word: 'col', image: 'https://placehold.co/120x120/FF0000/FFF?text=Col' }, // Placeholder image for Col
                        { word: 'flor', image: 'https://placehold.co/120x120/00FF00/FFF?text=Flor' }, // Placeholder image for Flor
                        { word: 'mesa', image: 'https://placehold.co/120x120/0000FF/FFF?text=Mesa' } // Placeholder image for Mesa
                    ]
                },
                {
                    id: 'intrasilabica-2',
                    type: 'sonido-inicial-silaba',
                    prompt: 'pelota',
                    image: 'https://placehold.co/200x200/8A2BE2/FFF?text=Pelota', // Placeholder image for Pelota
                    correctAnswer: 'pe',
                    options: ['pe', 'lo', 'ta', 'pa']
                },
                {
                    id: 'intrasilabica-3',
                    type: 'encontrar-rimas',
                    prompt: 'conejo',
                    image: 'https://placehold.co/200x200/DAA520/FFF?text=Conejo', // Placeholder image for Conejo
                    correctAnswer: 'espejo',
                    options: [
                        { word: 'cereza', image: 'https://placehold.co/120x120/FF6347/FFF?text=Cereza' }, // Placeholder image for Cereza
                        { word: 'espejo', image: 'https://placehold.co/120x120/8B008B/FFF?text=Espejo' }, // Placeholder image for Espejo
                        { word: 'queso', image: 'https://placehold.co/120x120/F0E68C/000?text=Queso' } // Placeholder image for Queso
                    ]
                },
                {
                    id: 'intrasilabica-4',
                    type: 'sonido-inicial-silaba',
                    prompt: 'jirafa',
                    image: 'https://placehold.co/200x200/FFA07A/000?text=Jirafa', // Placeholder image for Jirafa
                    correctAnswer: 'ji',
                    options: ['ji', 'ra', 'fa', 'ga']
                }
            ],
            fonemica: [
                {
                    id: 'fonemica-1',
                    type: 'sonido-inicial-fonema',
                    prompt: 'mesa',
                    image: 'https://placehold.co/200x200/4B0082/FFF?text=Mesa', // Placeholder image for Mesa
                    correctAnswer: 'm',
                    options: ['m', 'p', 's', 'l']
                },
                {
                    id: 'fonemica-2',
                    type: 'sonido-final-fonema',
                    prompt: 'pez',
                    image: 'https://placehold.co/200x200/FFC0CB/000?text=Pez', // Placeholder image for Pez
                    correctAnswer: 'z',
                    options: ['p', 'e', 'z', 'l']
                },
                {
                    id: 'fonemica-3',
                    type: 'sonido-inicial-fonema',
                    prompt: 'casa',
                    image: 'https://placehold.co/200x200/A0522D/FFF?text=Casa', // Placeholder image for Casa
                    correctAnswer: 'c',
                    options: ['c', 'g', 'q', 'k']
                },
                {
                    id: 'fonemica-4',
                    type: 'sonido-final-fonema',
                    prompt: 'arbol',
                    image: 'https://placehold.co/200x200/8B4513/FFF?text=Arbol', // Placeholder image for Arbol
                    correctAnswer: 'l',
                    options: ['a', 'r', 'b', 'l']
                }
            ]
        };

        // Obtención de referencias a los elementos del DOM
        const welcomeScreen = document.getElementById('welcome-screen');
        const levelSelectionScreen = document.getElementById('level-selection-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelSummaryScreen = document.getElementById('level-summary-screen');
        const gameOverScreen = document.getElementById('game-over-screen');

        const startGameBtn = document.getElementById('start-game-btn');
        const levelButtons = document.querySelectorAll('#level-selection-screen .btn');
        const levelTitle = document.getElementById('level-title');
        const questionText = document.getElementById('question-text');
        const activityImage = document.getElementById('activity-image');
        const playSoundBtn = document.getElementById('play-sound-btn');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextActivityBtn = document.getElementById('next-activity-btn');
        const scoreDisplay = document.getElementById('score-display');

        const summaryLevelName = document.getElementById('summary-level-name');
        const levelScoreDisplay = document.getElementById('level-score-display');
        const levelTotalQuestions = document.getElementById('level-total-questions');
        const returnToLevelsBtn = document.getElementById('return-to-levels-btn');
        const restartGameFromSummaryBtn = document.getElementById('restart-game-from-summary-btn');

        const finalScoreDisplay = document.getElementById('final-score-display');
        const restartGameBtn = document.getElementById('restart-game-btn');

        // Variables de estado del juego
        let currentLevel = ''; // Nivel actual seleccionado (e.g., 'silabica', 'intrasilabica')
        let currentActivityIndex = 0; // Índice de la actividad actual dentro del nivel
        let score = 0; // Puntuación total acumulada en todo el juego
        let levelScore = 0; // Puntuación acumulada en el nivel actual
        let answeredCorrectly = false; // Bandera para controlar si la actividad actual ya fue respondida correctamente
        let selectedSyllables = []; // Para actividades de segmentar sílabas, guarda las sílabas seleccionadas por el usuario
        let correctSyllableIndex = 0; // Para actividades de segmentar sílabas, controla el índice de la sílaba correcta esperada

        /**
         * Muestra la pantalla especificada y oculta todas las demás pantallas del juego.
         * @param {HTMLElement} screenToShow - El elemento DOM de la pantalla a mostrar.
         */
        function showScreen(screenToShow) {
            welcomeScreen.classList.add('hidden');
            levelSelectionScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            levelSummaryScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            screenToShow.classList.remove('hidden');
        }

        // Event listener para el botón "Comenzar Juego" en la pantalla de bienvenida
        startGameBtn.addEventListener('click', () => {
            showScreen(levelSelectionScreen);
            score = 0; // Reiniciar puntuación total al iniciar un nuevo juego desde cero
            updateScoreDisplay(); // Actualizar la visualización de la puntuación
        });

        // Event listeners para los botones de selección de nivel
        levelButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                currentLevel = event.target.dataset.level; // Obtener el nivel del atributo data-level
                currentActivityIndex = 0; // Reiniciar el índice de actividad para el nuevo nivel
                levelScore = 0; // Reiniciar la puntuación del nivel
                showScreen(gameScreen); // Mostrar la pantalla de juego
                loadActivity(); // Cargar la primera actividad del nivel seleccionado
            });
        });

        /**
         * Actualiza el texto de visualización de la puntuación total en la esquina superior derecha.
         */
        function updateScoreDisplay() {
            scoreDisplay.textContent = `Puntuación: ${score}`;
        }

        /**
         * Carga y muestra la actividad actual del nivel.
         * Maneja la lógica para pasar a la pantalla de resumen del nivel si todas las actividades han sido completadas.
         */
        function loadActivity() {
            // Ocultar mensajes de retroalimentación y botón de siguiente al cargar una nueva actividad
            feedbackMessage.classList.add('hidden');
            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('feedback-correct', 'feedback-incorrect');
            nextActivityBtn.classList.add('hidden');
            answeredCorrectly = false; // Resetear el estado de respuesta para la nueva actividad

            const activities = gameData[currentLevel];
            // Si el índice de la actividad actual excede el número de actividades en el nivel, el nivel ha terminado.
            if (currentActivityIndex >= activities.length) {
                showLevelSummary(); // Mostrar el resumen del nivel
                return;
            }

            const activity = activities[currentActivityIndex]; // Obtener la actividad actual
            let levelName = '';
            // Asignar un nombre legible al nivel actual
            if (currentLevel === 'silabica') levelName = 'Conciencia Silábica';
            else if (currentLevel === 'intrasilabica') levelName = 'Conciencia Intrasilábica';
            else if (currentLevel === 'fonemica') levelName = 'Conciencia Fonémica';

            levelTitle.textContent = `Nivel: ${levelName}`; // Actualizar el título del nivel
            questionText.textContent = `¿${activity.prompt.charAt(0).toUpperCase() + activity.prompt.slice(1)}?`; // Mostrar la pregunta, capitalizando la primera letra
            activityImage.src = activity.image; // Cargar la imagen de la actividad
            activityImage.alt = activity.prompt; // Texto alternativo para la imagen

            optionsContainer.innerHTML = ''; // Limpiar opciones anteriores para la nueva actividad

            // Mezclar opciones para que no siempre aparezcan en el mismo orden, añadiendo un factor de aleatoriedad
            const shuffledOptions = [...activity.options].sort(() => Math.random() - 0.5);

            // Renderizar las opciones según el tipo de actividad
            switch (activity.type) {
                case 'segmentar-silabas':
                    questionText.textContent = `Haz clic en las sílabas en el orden correcto de "${activity.prompt}":`;
                    shuffledOptions.forEach(option => {
                        const btn = document.createElement('button');
                        btn.classList.add('option-btn');
                        btn.textContent = option;
                        btn.dataset.value = option;
                        btn.addEventListener('click', () => handleSyllableClick(btn, activity.correctAnswer));
                        optionsContainer.appendChild(btn);
                    });
                    break;
                case 'contar-silabas':
                    questionText.textContent = `¿Cuántas sílabas tiene "${activity.prompt}"?`;
                    shuffledOptions.forEach(option => {
                        const btn = document.createElement('button');
                        btn.classList.add('option-btn');
                        btn.textContent = option;
                        btn.dataset.value = option;
                        btn.addEventListener('click', () => checkAnswer(option, activity.correctAnswer));
                        optionsContainer.appendChild(btn);
                    });
                    break;
                case 'encontrar-rimas':
                    questionText.textContent = `¿Qué palabra rima con "${activity.prompt}"?`;
                    shuffledOptions.forEach(option => {
                        const btn = document.createElement('button');
                        btn.classList.add('option-btn', 'flex', 'flex-col', 'items-center');
                        const img = document.createElement('img');
                        img.src = option.image;
                        img.alt = option.word;
                        img.classList.add('w-24', 'h-24', 'object-contain', 'mb-2', 'rounded-md'); // Tamaño fijo y responsive para imágenes de rimas
                        const span = document.createElement('span');
                        span.textContent = option.word;
                        btn.appendChild(img);
                        btn.appendChild(span);
                        btn.dataset.value = option.word;
                        btn.addEventListener('click', () => checkAnswer(option.word, activity.correctAnswer));
                        optionsContainer.appendChild(btn);
                    });
                    break;
                case 'sonido-inicial-silaba':
                    questionText.textContent = `¿Cuál es la primera sílaba de "${activity.prompt}"?`;
                    shuffledOptions.forEach(option => {
                        const btn = document.createElement('button');
                        btn.classList.add('option-btn');
                        btn.textContent = option.toUpperCase(); // Mostrar en mayúsculas para claridad
                        btn.dataset.value = option;
                        btn.addEventListener('click', () => checkAnswer(option, activity.correctAnswer));
                        optionsContainer.appendChild(btn);
                    });
                    break;
                case 'sonido-inicial-fonema':
                    questionText.textContent = `¿Con qué sonido (letra) empieza "${activity.prompt}"?`;
                    shuffledOptions.forEach(option => {
                        const btn = document.createElement('button');
                        btn.classList.add('option-btn');
                        btn.textContent = option.toUpperCase(); // Mostrar en mayúsculas
                        btn.dataset.value = option;
                        btn.addEventListener('click', () => checkAnswer(option, activity.correctAnswer));
                        optionsContainer.appendChild(btn);
                    });
                    break;
                case 'sonido-final-fonema':
                    questionText.textContent = `¿Con qué sonido (letra) termina "${activity.prompt}"?`;
                    shuffledOptions.forEach(option => {
                        const btn = document.createElement('button');
                        btn.classList.add('option-btn');
                        btn.textContent = option.toUpperCase(); // Mostrar en mayúsculas
                        btn.dataset.value = option;
                        btn.addEventListener('click', () => checkAnswer(option, activity.correctAnswer));
                        optionsContainer.appendChild(btn);
                    });
                    break;
            }
        }

        /**
         * Maneja el clic en las sílabas para la actividad de "segmentar-silabas".
         * Verifica si la sílaba seleccionada está en el orden correcto.
         * @param {HTMLElement} clickedBtn - El botón de sílaba que fue clicado.
         * @param {string[]} correctAnswer - El array de sílabas correctas en orden.
         */
        let selectedSyllables = [];
        let correctSyllableIndex = 0;
        function handleSyllableClick(clickedBtn, correctAnswer) {
            if (answeredCorrectly) return; // Si ya se ha respondido correctamente, ignorar clics adicionales

            const clickedValue = clickedBtn.dataset.value;

            // Marcar la sílaba como seleccionada visualmente si no ha sido seleccionada antes
            if (!clickedBtn.classList.contains('selected') && !clickedBtn.classList.contains('correct') && !clickedBtn.classList.contains('incorrect')) {
                clickedBtn.classList.add('selected'); // Marcar temporalmente como seleccionado
                selectedSyllables.push(clickedValue);

                // Comprobar si la sílaba seleccionada coincide con la siguiente sílaba esperada en la secuencia correcta
                if (selectedSyllables[correctSyllableIndex] === correctAnswer[correctSyllableIndex]) {
                    // Si es correcta, actualizar estado visual a 'correct' y avanzar en la secuencia
                    clickedBtn.classList.remove('selected');
                    clickedBtn.classList.add('correct');
                    correctSyllableIndex++;

                    // Si todas las sílabas han sido seleccionadas en el orden correcto
                    if (correctSyllableIndex === correctAnswer.length) {
                        showFeedback(true); // Mostrar retroalimentación de éxito
                        answeredCorrectly = true; // Marcar actividad como respondida
                        score += 10; // Sumar puntos al score total
                        levelScore += 10; // Sumar puntos al score del nivel
                        updateScoreDisplay(); // Actualizar score en pantalla
                        nextActivityBtn.classList.remove('hidden'); // Mostrar botón para siguiente actividad
                    }
                } else {
                    // Si la sílaba seleccionada es incorrecta en la secuencia
                    showFeedback(false); // Mostrar retroalimentación de error
                    answeredCorrectly = true; // Marcar actividad como respondida (para deshabilitar más intentos)
                    clickedBtn.classList.add('incorrect'); // Marcar botón clicado como incorrecto

                    // Para esta actividad específica, si la primera sílaba ya es incorrecta,
                    // deshabilitar los demás botones para que el usuario pueda avanzar.
                    optionsContainer.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                    nextActivityBtn.classList.remove('hidden'); // Mostrar botón para siguiente actividad
                }
            }
        }


        /**
         * Verifica la respuesta general para actividades de selección (contar sílabas, rimas, sonidos iniciales/finales).
         * @param {*} selectedValue - El valor seleccionado por el usuario.
         * @param {*} correctAnswer - El valor de la respuesta correcta.
         */
        function checkAnswer(selectedValue, correctAnswer) {
            if (answeredCorrectly) return; // Si ya se ha respondido, ignorar clics adicionales

            const isCorrect = selectedValue === correctAnswer; // Comparar la respuesta del usuario con la correcta
            showFeedback(isCorrect); // Mostrar retroalimentación
            answeredCorrectly = true; // Marcar actividad como respondida

            // Deshabilitar todos los botones de opción y aplicar clases visuales de retroalimentación
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true; // Deshabilitar el botón
                if (btn.dataset.value == selectedValue) { // Usar '==' para comparación flexible (números vs. strings)
                    if (isCorrect) {
                        btn.classList.add('correct');
                    } else {
                        btn.classList.add('incorrect');
                    }
                } else if (btn.dataset.value == correctAnswer) {
                    // Si la respuesta fue incorrecta, resaltar la opción correcta
                    btn.classList.add('correct');
                }
            });

            if (isCorrect) {
                score += 10; // Sumar puntos al score total si es correcta
                levelScore += 10; // Sumar puntos al score del nivel
            }
            updateScoreDisplay(); // Actualizar score en pantalla
            nextActivityBtn.classList.remove('hidden'); // Mostrar botón para siguiente actividad
        }

        /**
         * Muestra un mensaje de retroalimentación al usuario (correcto/incorrecto).
         * @param {boolean} isCorrect - True si la respuesta fue correcta, false si fue incorrecta.
         */
        function showFeedback(isCorrect) {
            feedbackMessage.classList.remove('hidden'); // Mostrar el contenedor del mensaje
            if (isCorrect) {
                feedbackMessage.textContent = '¡Correcto! ¡Muy bien!';
                feedbackMessage.classList.remove('feedback-incorrect');
                feedbackMessage.classList.add('feedback-correct');
            } else {
                feedbackMessage.textContent = 'Incorrecto. ¡Sigue intentándolo!';
                feedbackMessage.classList.remove('feedback-correct');
                feedbackMessage.classList.add('feedback-incorrect');
            }
        }

        // Event listener para el botón "Reproducir Sonido"
        playSoundBtn.addEventListener('click', () => {
            const activity = gameData[currentLevel][currentActivityIndex];
            const wordToPronounce = activity.prompt;
            // En un entorno real, aquí se usaría la API Web Audio o un elemento <audio> HTML
            // para reproducir un archivo de sonido. Para esta demostración, mostramos un mensaje.
            feedbackMessage.classList.remove('hidden', 'feedback-correct', 'feedback-incorrect');
            feedbackMessage.textContent = `Reproduciendo sonido: "${wordToPronounce}"`;
            feedbackMessage.style.backgroundColor = '#E0F7FA'; // Color para el mensaje de sonido
            feedbackMessage.style.color = '#006064';
            feedbackMessage.style.borderColor = '#4DD0E1';
        });

        // Event listener para el botón "Siguiente Actividad"
        nextActivityBtn.addEventListener('click', () => {
            currentActivityIndex++; // Avanzar al siguiente índice de actividad
            selectedSyllables = []; // Resetear para la siguiente actividad de segmentación de sílabas
            correctSyllableIndex = 0; // Resetear para la siguiente actividad de segmentación de sílabas
            loadActivity(); // Cargar la siguiente actividad
        });

        /**
         * Muestra la pantalla de resumen del nivel actual.
         * También verifica si todos los niveles han sido completados para mostrar la pantalla de juego terminado.
         */
        function showLevelSummary() {
            let levelName = '';
            // Obtener el nombre legible del nivel actual
            if (currentLevel === 'silabica') levelName = 'Conciencia Silábica';
            else if (currentLevel === 'intrasilabica') levelName = 'Conciencia Intrasilábica';
            else if (currentLevel === 'fonemica') levelName = 'Conciencia Fonémica';

            summaryLevelName.textContent = levelName; // Mostrar el nombre del nivel
            levelScoreDisplay.textContent = levelScore; // Mostrar la puntuación obtenida en este nivel
            levelTotalQuestions.textContent = gameData[currentLevel].length * 10; // Calcular el total de puntos posibles para este nivel
            showScreen(levelSummaryScreen); // Mostrar la pantalla de resumen del nivel

            // Determinar si es el último nivel y si todas sus actividades han sido procesadas
            const allLevelKeys = Object.keys(gameData);
            const isLastLevel = allLevelKeys.indexOf(currentLevel) === allLevelKeys.length - 1;
            const allActivitiesInCurrentLevelCompleted = currentActivityIndex >= gameData[currentLevel].length;

            if (isLastLevel && allActivitiesInCurrentLevelCompleted) {
                 showGameOverScreen(); // Si es el último nivel y se completó, mostrar la pantalla de juego terminado
            }
        }

        // Event listener para el botón "Volver a Niveles" en la pantalla de resumen de nivel
        returnToLevelsBtn.addEventListener('click', () => {
            showScreen(levelSelectionScreen); // Volver a la pantalla de selección de niveles
        });

        // Event listener para el botón "Reiniciar Juego" en la pantalla de resumen de nivel
        restartGameFromSummaryBtn.addEventListener('click', () => {
            resetGame(); // Resetear todas las variables del juego
            showScreen(welcomeScreen); // Volver a la pantalla de bienvenida
        });

        /**
         * Muestra la pantalla final de juego terminado.
         */
        function showGameOverScreen() {
            finalScoreDisplay.textContent = score; // Mostrar la puntuación total final
            showScreen(gameOverScreen); // Mostrar la pantalla de juego terminado
        }

        // Event listener para el botón "Jugar de Nuevo" en la pantalla de juego terminado
        restartGameBtn.addEventListener('click', () => {
            resetGame(); // Resetear todas las variables del juego
            showScreen(welcomeScreen); // Volver a la pantalla de bienvenida
        });

        /**
         * Resetea todas las variables de estado del juego a sus valores iniciales.
         * Utilizado para reiniciar un juego completo.
         */
        function resetGame() {
            currentLevel = '';
            currentActivityIndex = 0;
            score = 0;
            levelScore = 0;
            answeredCorrectly = false;
            selectedSyllables = [];
            correctSyllableIndex = 0;
            updateScoreDisplay(); // Asegurar que la puntuación en pantalla también se reinicie
        }

        // Inicializa el juego mostrando la pantalla de bienvenida al cargar la página.
        showScreen(welcomeScreen);
    </script>
</body>
</html>
